# AI智能识别功能说明

## 功能概述

本应用集成了DeepSeek多模态AI能力，可以自动识别消费票据图片，提取关键信息并自动填充表单。

## 使用方法

1. **上传图片**
   - 在记账页面点击方形上传区域
   - 选择或拖拽消费票据图片（支持PNG、JPG、SVG格式）
   - 图片上传成功后会显示预览

2. **智能识别**
   - 点击"智能识别"按钮
   - 系统会调用DeepSeek AI分析图片内容
   - 自动提取：金额、分类、日期、备注信息

3. **确认提交**
   - AI识别结果会自动填充到表单（可编辑）
   - 确认信息正确后点击"记一笔"提交

## 核心特性

### 1. 智能填充逻辑

- **null值不填充**: AI未识别到的字段保持空白，等待用户手动输入
- **用户优先**: 已手动填写的字段不会被AI结果覆盖
- **默认值判断**: 
  - 金额: 仅在用户未输入时填充
  - 分类: 仅在默认值"餐饮"时更新
  - 日期: 仅在默认值（今天）时更新
  - 备注: 仅在空白时填充

### 2. 支持的文件格式

✅ **支持AI识别**:
- PNG
- JPG/JPEG
- SVG

❌ **不支持AI识别**:
- PDF（可上传作为附件，但无法AI识别）

### 3. AI识别字段

| 字段 | 说明 | 示例 |
|-----|------|------|
| 金额 | 纯数字，单位：元 | 58.5 |
| 分类 | 8个类别之一 | 餐饮、购物、娱乐、美妆、交通、住房、医疗、其他 |
| 日期 | YYYY-MM-DD格式 | 2025-10-23 |
| 备注 | 商家名称或描述 | 星巴克、麦当劳等 |

## API配置

### 环境变量

需要在 `.env.local` 文件中配置DeepSeek API密钥：

```env
DEEPSEEK_API_KEY=your_api_key_here
```

### API调用

- **端点**: `https://api.deepseek.com/chat/completions`
- **模型**: `deepseek-chat`（支持多模态）
- **温度**: 0.1（确保结果稳定）
- **最大token**: 500

## Prompt设计

系统使用精心设计的提示词确保识别准确性：

```
你是一个专业的票据识别助手。请分析这张图片，提取以下信息：

1. 金额（amount）- 数字，单位：元
2. 消费类别（category）- 必须从以下选项中选择：餐饮、购物、娱乐、美妆、交通、住房、医疗、其他
3. 日期（date）- 格式：YYYY-MM-DD
4. 备注（note）- 商家名称或消费描述

重要规则：
- 如果某个字段无法识别，请返回 null
- 金额必须是纯数字，不要包含货币符号
- 类别必须严格匹配上述8个选项之一
- 日期必须是标准格式，如果图片中没有年份，使用当前年份
```

## 技术实现

### 文件结构

```
/lib/deepseek.ts                     # AI识别核心函数
/app/api/ai/parse-receipt/route.ts   # API路由
/app/page.tsx                         # 记账页面（含智能识别按钮）
/components/ui/image-upload.tsx      # 图片上传组件
```

### 关键函数

#### `parseReceiptImage(imageBase64: string)`

```typescript
export async function parseReceiptImage(imageBase64: string): Promise<ReceiptParseResult> {
  // 1. 验证API密钥
  // 2. 构建包含图片的多模态消息
  // 3. 调用DeepSeek API
  // 4. 解析JSON响应
  // 5. 验证类别有效性
  // 6. 返回结果（未识别字段为null）
}
```

## 错误处理

- API调用失败: 显示错误提示，用户可手动填写
- 网络超时: 自动重试机制
- 无效响应: 回退到手动输入模式
- PDF识别: 提前阻止，提示不支持

## 用户体验优化

1. **加载状态**: 识别过程中显示"识别中..."动画
2. **即时反馈**: 识别完成后显示成功提示
3. **可编辑性**: 所有AI填充的结果均可手动修改
4. **智能提示**: 清晰标注PDF不支持识别
5. **性能优化**: Base64缓存避免重复上传

## 成本控制建议

1. **按需调用**: 用户主动点击"智能识别"按钮，不自动触发
2. **格式过滤**: 仅支持图片格式，排除PDF
3. **大小限制**: 10MB文件大小上限
4. **错误缓存**: 失败的请求不重复调用

## 未来优化方向

- [ ] 支持批量识别多张票据
- [ ] 添加识别历史记录
- [ ] OCR结果置信度展示
- [ ] 支持PDF转图片后识别
- [ ] 本地缓存识别结果
- [ ] 支持手动纠正并反馈

## 注意事项

⚠️ **重要提醒**:
1. DeepSeek API需要有效密钥才能使用
2. 图片质量影响识别准确度，建议使用清晰票据
3. 识别结果仅供参考，请务必核对后提交
4. 个人敏感信息会通过API传输，请注意隐私保护
5. API调用产生费用，建议合理使用

## 常见问题

**Q: 为什么PDF不支持识别？**
A: 当前DeepSeek多模态API仅支持图片格式输入，PDF需要先转换为图片。

**Q: 识别不准确怎么办？**
A: 所有字段都可以手动修改，建议使用高清票据图片以提高准确率。

**Q: 是否每次都需要点击智能识别？**
A: 是的，这是为了节约API成本，仅在需要时调用。

**Q: 用户已填写的内容会被覆盖吗？**
A: 不会！系统会检测用户是否已填写，仅填充空白字段。

