# AI识别Prompt优化说明

## 优化目标

1. ✅ AI只提取图片中明确显示的信息，不进行推理和猜想
2. ✅ 没有显示的信息返回null，不补充默认值
3. ✅ 前端正确处理null值，将对应表单字段设为空

## Prompt优化内容

### 优化前的问题

❌ **会自动补充年份**
- 旧prompt：`如果图片中没有年份，使用当前年份2025`
- 问题：AI会主动补充缺失的信息

❌ **缺少严格的识别规则**
- 没有明确要求"不推理、不猜测"
- AI可能基于上下文推测缺失字段

❌ **空值处理不明确**
- 没有明确说明何时返回null
- 没有禁止使用空字符串

### 优化后的改进

#### 1. 识别规则明确化

```
【识别规则】
1. 仅识别和提取图片中明确显示的信息
2. 不要进行任何推理、猜测或补充
3. 没有明确显示的信息必须返回 null
4. 不要基于其他信息推测缺失的字段
```

#### 2. 字段提取规则细化

**金额 (amount)**
- ✅ 只提取明确显示的数字
- ✅ 去除货币符号
- ✅ 没有金额 → 返回 null

**消费类别 (category)**
- ✅ 必须有明确依据才判断
- ✅ 无法判断 → 返回 null
- ✅ 不要猜测

**日期 (date)**
- ✅ 只提取明确显示的完整日期
- ✅ **只有月日没有年份 → 返回 null（不补充）**
- ✅ 完全没有日期 → 返回 null

**备注 (note)**
- ✅ 只提取图片上的文字
- ✅ 不添加任何描述
- ✅ 没有文字 → 返回 null

#### 3. 特殊情况处理

```
【特殊情况处理】
- 完全无法识别 → {"error": "UNRECOGNIZABLE"}
- 图片清晰但所有字段都无法提取 → 返回所有字段为null的正常JSON
```

#### 4. 输出格式规范

```
【重要提醒】
- 只返回JSON，不要有任何其他说明文字
- null表示该字段在图片中不存在或无法识别
- 不要用空字符串""，必须用null
- 不要推测、不要猜想、不要补充信息
```

## 前端逻辑优化

### 空值处理策略

#### 优化前
```typescript
// 只在有值时填充
if (data.amount !== null) {
  setAmount(data.amount.toString())
}
// 如果AI返回null，字段保持原值
```

#### 优化后
```typescript
// null、undefined、空字符串都视为"未识别"
if (data.amount !== null && data.amount !== undefined && data.amount !== '') {
  setAmount(data.amount.toString())
} else {
  setAmount('') // 明确清空字段
}
```

### 各字段的处理逻辑

| 字段 | AI返回null时的行为 | 说明 |
|-----|------------------|------|
| amount | `setAmount('')` | 清空金额，必须手动填写 |
| category | `setCategory('餐饮')` | 恢复默认值 |
| date | `setDate(getCurrentDate())` | 使用今天日期 |
| note | `setNote('')` | 清空备注 |

### 为什么这样设计？

1. **金额和备注清空**
   - 这两个字段用户必须明确知道
   - 避免误填导致记账错误

2. **类别恢复默认**
   - 必须有一个选中值
   - 默认"餐饮"是最常见场景

3. **日期使用今天**
   - 大部分情况是当天消费
   - 如果不对用户可以手动修改

## 识别示例

### 示例1：完整票据

**图片内容：**
```
星巴克
2025-10-23
拿铁咖啡
¥38.00
```

**AI返回：**
```json
{
  "amount": 38,
  "category": "餐饮",
  "date": "2025-10-23",
  "note": "星巴克 拿铁咖啡"
}
```

**表单填充：**
- 金额：38
- 类别：餐饮
- 日期：2025-10-23
- 备注：星巴克 拿铁咖啡

---

### 示例2：缺少年份的票据

**图片内容：**
```
肯德基
10-22（只有月日）
套餐
¥45.00
```

**AI返回：**
```json
{
  "amount": 45,
  "category": "餐饮",
  "date": null,  // 没有年份，不补充
  "note": "肯德基 套餐"
}
```

**表单填充：**
- 金额：45
- 类别：餐饮
- 日期：2025-10-23（使用今天）⚠️ 用户需确认
- 备注：肯德基 套餐

---

### 示例3：只有金额的图片

**图片内容：**
```
¥120
（只有一个金额数字）
```

**AI返回：**
```json
{
  "amount": 120,
  "category": null,  // 无法判断类别
  "date": null,      // 没有日期
  "note": null       // 没有文字
}
```

**表单填充：**
- 金额：120
- 类别：餐饮（默认值）⚠️ 用户需手动选择
- 日期：2025-10-23（今天）⚠️ 用户需确认
- 备注：（空）

---

### 示例4：模糊不清的图片

**图片内容：**
```
（图片模糊，无法识别）
```

**AI返回：**
```json
{
  "error": "UNRECOGNIZABLE"
}
```

**行为：**
- 显示橙色警告Toast
- 提示：⚠️ AI无法理解本图片的含义，请手动填写或更换清晰的票据图片
- 表单不做任何修改

---

## 用户体验改进

### 1. 信息透明

✅ **AI未识别的字段会被清空或恢复默认**
- 用户能明确知道哪些字段需要手动填写
- 避免遗留旧数据造成误判

### 2. 减少错误

✅ **不推测、不猜想**
- 避免AI"自作聪明"补充错误信息
- 特别是日期，不会错误补充年份

### 3. 灵活修正

✅ **所有字段都可修改**
- AI识别完成后，用户可以修改任何字段
- 识别不准确时，手动修正即可

## 最佳实践

### 上传清晰的票据图片

✅ **推荐：**
- 拍照时保持平稳，避免模糊
- 确保光线充足
- 票据信息完整（包括金额、日期、商家）

❌ **避免：**
- 模糊、反光的照片
- 只拍摄部分内容
- 手写潦草难以辨认

### 识别后的检查

1. ✅ **检查金额** - 最重要，必须准确
2. ✅ **检查日期** - 特别注意AI未识别的情况
3. ✅ **检查类别** - 确认分类是否正确
4. ✅ **补充备注** - 添加AI未提取的信息

## 技术实现

### 关键代码位置

1. **Prompt定义**
   - 文件：`lib/deepseek.ts`
   - 函数：`parseReceiptImageGLM()`
   - 行数：167-216

2. **空值处理**
   - 文件：`app/page.tsx`
   - 函数：`handleSmartRecognition()`
   - 行数：118-142

3. **返回类型**
   - 文件：`lib/deepseek.ts`
   - 接口：`ReceiptParseResult`
   - 行数：6-12

### 数据流

```
图片上传
    ↓
Base64编码
    ↓
调用 GLM-4V API（使用优化后的prompt）
    ↓
返回JSON（严格遵循null规则）
    ↓
前端解析JSON
    ↓
检查每个字段
    ↓
null → 清空或恢复默认
非null → 填充识别结果
    ↓
显示成功提示
    ↓
用户确认/修改
    ↓
保存记录
```

## 注意事项

⚠️ **AI识别不是100%准确**
- 始终需要用户确认
- 特别是金额和日期

⚠️ **null值的含义**
- null = AI未识别到该信息
- 不代表图片中一定没有
- 可能是图片不清晰或AI能力限制

⚠️ **日期特别注意**
- 如果图片只有月日，AI会返回null
- 前端会自动使用今天日期
- 用户务必检查是否正确

## 后续优化方向

- [ ] 添加识别置信度显示
- [ ] 标注哪些字段是AI识别的
- [ ] 提供"重新识别"按钮
- [ ] 记录识别准确率统计

---

## JSON解析增强（v2.1更新）

### 问题描述

在实际使用中，发现GLM可能返回格式如：
```
【示例】预结单 大... {"amount": 100, ...}
```

导致JSON解析失败：`Unexpected token '【'`

### 解决方案

#### 1. Prompt强化

添加明确的错误示例和正确示例：

```
【重要提醒】
- 只返回JSON对象，不要有任何其他说明文字
- 不要在JSON前后添加任何文字、标题、示例等
- 不要使用【】、「」等中文标点符号

【错误示例 - 不要这样做】
❌ 【示例】预结单 大... {"amount": 100, ...}
❌ 识别结果如下：{"amount": 100, ...}
❌ 在JSON外添加任何文字或代码块标记

【正确示例 - 只返回纯JSON】
✅ {"amount": 100, "category": "餐饮", "date": "2025-10-23", "note": "星巴克"}
✅ {"error": "UNRECOGNIZABLE"}
```

#### 2. 智能JSON提取

即使AI不遵守规则，也能正确提取JSON：

```typescript
// 移除markdown代码块
let jsonText = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim()

// 提取第一个{到最后一个}之间的内容
const firstBrace = jsonText.indexOf('{')
const lastBrace = jsonText.lastIndexOf('}')

if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
  jsonText = jsonText.substring(firstBrace, lastBrace + 1)
}

// 解析JSON并捕获错误
try {
  result = JSON.parse(jsonText)
} catch (parseError) {
  console.error('JSON parse error:', parseError)
  console.error('Raw content:', content)
  console.error('Extracted JSON text:', jsonText)
  throw new Error('Failed to parse AI response as JSON')
}
```

#### 3. 处理流程

```
AI返回内容
    ↓
移除markdown代码块标记
    ↓
查找第一个 { 和最后一个 }
    ↓
提取中间的JSON字符串
    ↓
解析JSON
    ↓
    ├─ 成功 → 返回结果
    └─ 失败 → 详细错误日志 + 抛出异常
```

#### 4. 示例处理

| 原始返回 | 提取结果 | 状态 |
|---------|---------|------|
| `{"amount": 100, ...}` | `{"amount": 100, ...}` | ✅ 正常 |
| `【示例】... {"amount": 100}` | `{"amount": 100}` | ✅ 提取成功 |
| `识别结果：{"amount": 100}` | `{"amount": 100}` | ✅ 提取成功 |
| ` ```json\n{"amount": 100}\n``` ` | `{"amount": 100}` | ✅ 提取成功 |
| `没有JSON内容` | - | ❌ 抛出异常 |

---

**优化完成时间**: 2025-10-23  
**版本**: v2.1 (JSON解析增强)  
**状态**: ✅ 已上线

